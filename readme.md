## 串联小腿

### 物理结构
普通4连杆机构，由于膝关节存在一个限位，导致髋关节两个杆无法转到倒'V'型，使得该腿的环境适应性有限。

走线较为简单，四个髋关节CAN1接到前方下面分线板，两个轮电机CAN2经滑环到后面上分线板，后面下放置C板。

| 关键     | 内容                                                         |
| -------- | ------------------------------------------------------------ |
| 零点     | 电机对应的杆平行位置                                         |
| 正方向   | 左 前 1 逆时针+ ID1<br/>左 后 3 逆时针+ ID3<br/>右 前 2 顺时针+ ID2<br/>右 后 4 顺时针+ ID4 |
| 电机类型 | 髋关节 DM4310 2EC<br/>轮电机 DJI3508 + 减速箱                |
| 分配     | CAN1 髋关节电机<br/>CAN2 轮电机                              |

### CAN分配

| CAN  | 电机ID | 反馈ID(master) | 类型 | 正方向 |
| ---- | ------ | -------------- | ---- | ------ |
| CAN1 | 0x01   | 0x11           | 左前 | 逆时针 |
| CAN1 | 0x02   | 0x12           | 右前 | 顺时针 |
| CAN1 | 0x03   | 0x13           | 左后 | 逆时针 |
| CAN1 | 0x04   | 0x14           | 右后 | 顺时针 |
| CAN2 |        |                |      |        |
| CAN2 |        |                |      |        |

### 问题

- 达妙电机控制与反馈

  选择MIT模式作为控制模式 笔者发现达妙电机是有点东西的 (不好评价). 

  - 使能问题  

    在freertos任务中使能需加大约1ms的延时，~~定时器使能不需要~~ 不要定时器内只使能一次（或者说使能存在必须一定延时）

  - 发送问题

    达妙电机 (所有都有这个情况, 只要你总线上挂着达妙电机) 发送以三个为一组, 如果负载率过高, 会只保留第一组的所有值. 解决方案: 把你的总线电机分配至每个组都小于3, 每个包分别切换发送, 两次之间保证一定延时即可(开源测试保证200us即可, 我选择的是500us切换两组左右髋关节电机分别发送, 经测试满足1k控制频率, 收发没有明显问题). 
    
  - CAN负载
  
    笔者选择CAN 1M波特率, 因为达妙是一发一收, 所以发送频率决定接收频率. 在测试中, 发现200hz频率负载在8%左右, 1khz频率负载率在94%左右, 有极少数丢包情况. ~~目前选择的是1k频率. (由于达妙是一发一收, 最终上位机检测实际频率大于1k, 在1.2k左右)~~ 算了，CAN负载太高， 选取600us切换，单电机发送833hz，负载80%，1ms切换，单电机500hz，负载40%。选取1ms切换方案。
    
  - 控制选择:
  
    使用TIM7定时器发送CAN数据, 设置周期为500us, 实际运行周期 (包含CAN发送) 在0.4996-0.5000ms左右, 其中0.5000ms占比大于60%, 符合控制精度要求. 由于定时器默认是上电即启动, 会导致定时器发送可能吞掉初始化的命令. 采用初始化完成后启动定时器TIM7发送或者在定时器启动初始化都可以，笔者选择方法1，舍弃定时器启动。
  
    > 笔者还遇到一个超级抽象问题，电机2必须使能10次以上才行，其他都能一次即可，但是单独使能都可以一次使能。结果是分线板的对应端口有点虚连。所以一个良好的硬件很重要。

### TODO

- 定时器中使能static init改为电机状态参数
- 防止丢帧，使能多加几次
- 不同电机发送频率和解算频率的影响

### 日志

- 2025-12-29 完成简单走线和电机设置控制，可以写解算代码了
