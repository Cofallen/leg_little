## 串联小腿

### 物理结构
普通4连杆机构，由于膝关节存在一个限位，导致髋关节两个杆无法转到倒'V'型，使得该腿的环境适应性有限。

走线较为简单，四个髋关节CAN1接到前方下面分线板，两个轮电机CAN2经滑环到后面上分线板，后面下放置C板。

| 关键     | 内容                                                         |
| -------- | ------------------------------------------------------------ |
| 零点     | 电机对应的杆平行位置                                         |
| 正方向   | 左 前 1 逆时针+ ID1<br/>左 后 3 逆时针+ ID3<br/>右 前 2 顺时针+ ID2<br/>右 后 4 顺时针+ ID4 |
| 电机类型 | 髋关节 DM4310 2EC<br/>轮电机 DJI3508 + 减速箱                |
| 分配     | CAN1 髋关节电机<br/>CAN2 轮电机                              |

### CAN分配

| CAN  | 电机ID | 反馈ID(master) | 类型 | 正方向 |
| ---- | ------ | -------------- | ---- | ------ |
| CAN1 | 0x01   | 0x11           | 左前 | 逆时针 |
| CAN1 | 0x02   | 0x12           | 右前 | 逆时针 |
| CAN1 | 0x03   | 0x13           | 左后 | 逆时针 |
| CAN1 | 0x04   | 0x14           | 右后 | 逆时针 |
| CAN2 |        |                |      |        |
| CAN2 |        |                |      |        |

### 问题

- 达妙电机控制与反馈

  选择MIT模式作为控制模式 笔者发现达妙电机是有点东西的 (不好评价). 

  - 使能问题  

    在freertos任务中使能需加大约1ms的延时，~~定时器使能不需要~~ 不要定时器内只使能一次（或者说使能存在必须一定延时）

  - 发送问题

    达妙电机 (所有都有这个情况, 只要你总线上挂着达妙电机) 发送以三个为一组, 如果负载率过高, 会只保留第一组的所有值. 解决方案: 把你的总线电机分配至每个组都小于3, 每个包分别切换发送, 两次之间保证一定延时即可(开源测试保证200us即可, 我选择的是500us切换两组左右髋关节电机分别发送, 经测试满足1k控制频率, 收发没有明显问题). 
    
  - CAN负载
  
    笔者选择CAN 1M波特率, 因为达妙是一发一收, 所以发送频率决定接收频率. 在测试中, 发现200hz频率负载在8%左右, 1khz频率负载率在94%左右, 有极少数丢包情况. ~~目前选择的是1k频率. (由于达妙是一发一收, 最终上位机检测实际频率大于1k, 在1.2k左右)~~ 算了，CAN负载太高， 选取600us切换，单电机发送833hz，负载80%，1ms切换，单电机500hz，负载40%。选取1ms切换方案。
    
  - 控制选择:
  
    使用TIM7定时器发送CAN数据, 设置周期为500us, 实际运行周期 (包含CAN发送) 在0.4996-0.5000ms左右, 其中0.5000ms占比大于60%, 符合控制精度要求. 由于定时器默认是上电即启动, 会导致定时器发送可能吞掉初始化的命令. 采用初始化完成后启动定时器TIM7发送或者在定时器启动初始化都可以，笔者选择方法1，舍弃定时器启动。
  
    > 笔者还遇到一个超级抽象问题，电机2必须使能10次以上才行，其他都能一次即可，但是单独使能都可以一次使能。结果是分线板的对应端口有点虚连。所以一个良好的硬件很重要。


- 陀螺仪安装
R标朝位移正方向和仿真中陀螺仪反装极性一致，注意符号。

- 建模方向
TODO 粘图

左腿 phi 逆时针为负
右腿 phi 逆时针为负
低头 phi 左右 -+


- 极性
因为减速箱反装原因，导致仿真和实物还是有很多差异，起码我调试的过程是这样的。简要总结一下调试要点，有时间我在彻底统一和仿真的极性。（必须）TODO

注意机体应该能自稳，即车身朝一个方向偏，轮子会朝对应方向走来平衡。对于腿来说，~~调试极性应使车身朝下偏，左腿向后，右腿向前；车身朝上偏，左腿向前，右腿向后。~~ 应该是同左腿的方向偏，补偿重心变化。极性调试的没有问题，腿本身上电应不会转动，抖动，伸缩，轮应响应较为灵敏。注意不要给太大的力，调试的时候为了防止肘击，可以把对应项R权重给大，以削弱作用看极性。注意极性应轮电机改，髋关节一起改。

1. 板凳：因为绑腿的时候串腿比较难以完全相对于机体静止，故需要简要设置一下平衡零点。另对于腿来说板凳只是简要验证一下极性就好，所以只要能勉强稳定就可以。
```c
DJI_Torque_Control(&hcan2, 0x200, Leg_r.LQR.torque_setW, 0.0f, Leg_l.LQR.torque_setW, 0.0f);
```

2. 单腿去轮：确定 F T_p 计算没有问题，确定建模方向一致后，选择一组参数，保证不会连续转动，车身往两个方向倾，观察左右腿髋关节输出会不会使腿偏移。

注意，静止状态上电后应腿会保持竖直状态，不会转动，代表电机输出极性正确。此时观察腿转动方向，机体倾斜后，腿应找使得机体重心稳定的点的方向转动。若完成后，即调试完了总输出极性（或者这样理解，力矩极性，我这里认为力矩全为正值，改变总输出极性）。
```c
object->LQR.torque_setT[0] = object->vmc_calc.JRM[0][0] * object->LQR.F_0 + \
                             object->vmc_calc.JRM[0][1] * object->LQR.T_p;
object->LQR.torque_setT[1] = object->vmc_calc.JRM[1][0] * object->LQR.F_0 + \
                             object->vmc_calc.JRM[1][1] * object->LQR.T_p;

mit_ctrl(&hcan1, 0x01, 0,0,0,0, -Leg_l.LQR.torque_setT[0]);
mit_ctrl(&hcan1, 0x03, 0,0,0,0, -Leg_l.LQR.torque_setT[1]);
```

3. 单腿：加轮子后，调节R矩阵保证轮子不会太大，轻托另一侧腿，模拟平衡，让该腿自己去找平衡点，理论可以平衡。

4. 双腿去轮：~~注意建模方向，另一条腿正方向是反的（TODO 我能不能直接建模成一致的，这样防劈叉可能更好了），可能有点难以单腿平衡，建议腿的方向摆动与另一个是相反的，代表Ok~~

以上说法错误，右腿应镜像反对称建模，即偏移机体，转向相同。通过修正 $ \phi $ 的符号，确定两腿同方向摆动。
```c
object->stateSpace.phi = -imu->pitch / 57.3f;
```

5. 防劈叉：保证双腿向同方向摆动，补偿差距。建议先调这一个，一般双腿不加防劈叉会没有负载的情况下会有0.02以内的误差，调的时候可以随便指定一个极性，然后在kp选取正负测试极性是否正确，最后加上负载（即下地测试）看补偿效果。
```c
object->LQR.T_p = object->LQR.T_p + object->LQR.dF_delta;
const float Delta_control[3] = {100.0f, 0.01f, 0.0f};
PID_init(&object->pid.Delta, PID_POSITION, Delta_control, 10.0f, 0.0f);
```
最后发现限幅10还是有点小，最后误差在0.003左右。累了，随便调吧。

6. roll补偿：保证站立的时候车身不会倾斜过大

7. yaw补偿：保证不会疯转
```c
const float Yaw_control[3] = {1.0f, 0.001f, 250.0f};
PID_init(&object->pid.Yaw, PID_POSITION, Yaw_control, 0.4f, 0.0f);
```
注意两个电机最大输出扭矩，给个20%左右，观察pid输出的大小，可先全给正，然后在debug里选择Kp的正负值，观察err是否收敛，确定极性。

另外，该项kd需置大，否则会转动的时候一顿一顿然后走直线会左右摇晃。

- 支持力解算
和pid腿长有关，先调好腿长后再进行支持力解算。

### TODO

- 定时器中使能static init改为电机状态参数
- 防止丢帧，使能多加几次
- 不同电机发送频率和解算频率的影响

### 日志

- 2025-12-29 完成简单走线和电机设置控制，可以写解算代码了
- 2025-12-30 四点总算完成vmc正解算了，今年能让腿站起来吗
- 2026-1-2   串腿能站了！！可惜没有年前实现，话说极性也太难调了，比我写代码时间都长，不愧测试岗挣得多
- 2026-1-3   成功确定极性调法，比较稳定的一版，可惜没调lqr