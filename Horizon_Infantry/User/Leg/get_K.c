#include "get_K.h"

// 板凳会轻微转动
// Q = np.diag([600, 1, 5, 1, 1, 1])
// R_mat = np.diag([100, 1])
// float ChassisL_LQR_K[12] =  { -1.64301696, -0.14992515, -0.85214439, -0.97367536, 0.96852200, 0.22696223, 34.21996913, 1.48513016, 5.23306728, 4.15447659, -1.46933968, -0.22338112 };
// float ChassisR_LQR_K[12] =  { -1.64301696, -0.14992515, -0.85214439, -0.97367536, 0.96852200, 0.22696223, 34.21996913, 1.48513016, 5.23306728, 4.15447659, -1.46933968, -0.22338112 };

// 左腿测试正常
// Q = np.diag([1, 1, 100, 1, 1000, 1])
// R_mat = np.diag([10, 1]) 
// float ChassisL_LQR_K[12] =  { -3.40040427, -0.43470493, -2.55244837, -1.67991047, 6.79987889, 0.51566461, 5.83650540, 0.95838773, 5.90339507, 3.75943533, 24.58926978, 0.93786619 };
// float ChassisR_LQR_K[12] =  { -3.40040427, -0.43470493, -2.55244837, -1.67991047, 6.79987889, 0.51566461, 5.83650540, 0.95838773, 5.90339507, 3.75943533, 24.58926978, 0.93786619 };

// 双腿同方向离地
// Q = np.diag([1, 1, 100, 1, 1000, 1])
// R_mat = np.diag([1, 100]) 
// float ChassisL_LQR_K[12] = { -9.89729467, -1.58412154, -9.98816955, -6.27882147, 1.05970154, 0.45041359, 0.22653846, -0.00892277, -0.08878231, -0.06550984, 6.33382788, 0.51059776 };
// float ChassisR_LQR_K[12] = { -9.89729467, -1.58412154, -9.98816955, -6.27882147, 1.05970154, 0.45041359, 0.22653846, -0.00892277, -0.08878231, -0.06550984, 6.33382788, 0.51059776 };

// 双腿同方向离地
// float ChassisL_LQR_K[12] = { -10.20978096, -1.57644224, -9.87390062, -6.31627239, -2.40642826, 0.07609826, 0.17684005, -0.01871580, -0.15830624, -0.10943252, 3.72687301, 0.38021380 };
// float ChassisR_LQR_K[12] = { -10.20978096, -1.57644224, -9.87390062, -6.31627239, -2.40642826, 0.07609826, 0.17684005, -0.01871580, -0.15830624, -0.10943252, 3.72687301, 0.38021380 };

// 勉强站住
// Q = np.diag([1, 1, 30, 1, 2000, 1])
// R_mat = np.diag([100, 1])
// float ChassisL_LQR_K[12] =   { -1.85886133, -0.15720989, -0.38097508, -0.40200704, 3.70280433, 0.30539807, 9.24607883, 1.19437586, 3.93520001, 3.94367574, 29.27150994, 0.59105302 };
// float ChassisR_LQR_K[12] =   { -1.85886133, -0.15720989, -0.38097508, -0.40200704, 3.70280433, 0.30539807, 9.24607883, 1.19437586, 3.93520001, 3.94367574, 29.27150994, 0.59105302 };

// 站立
// Q = np.diag([1, 1, 10, 1, 2000, 1])
// R_mat = np.diag([100, 1]) 
// float ChassisL_LQR_K[12] = { -1.78702951, -0.14724413, -0.22322597, -0.29966946, 3.63846509, 0.29682657, 8.50978033, 1.09223834, 2.23986979, 2.89299819, 29.92784036, 0.67862636 };
// float ChassisR_LQR_K[12] = { -1.78702951, -0.14724413, -0.22322597, -0.29966946, 3.63846509, 0.29682657, 8.50978033, 1.09223834, 2.23986979, 2.89299819, 29.92784036, 0.67862636 };

// x有点晃
// Q = np.diag([1, 1, 100, 1, 2000, 1])
// R_mat = np.diag([100, 1]) 
// float ChassisL_LQR_K[12] = { -1.97259266, -0.17293065, -0.67911779, -0.56411679, 3.80220924, 0.31871893, 10.45648669, 1.36193851, 7.34029313, 5.68172359, 28.21812640, 0.44955057 };
// float ChassisR_LQR_K[12] = { -1.97259266, -0.17293065, -0.67911779, -0.56411679, 3.80220924, 0.31871893, 10.45648669, 1.36193851, 7.34029313, 5.68172359, 28.21812640, 0.44955057 };

// 以上为没有修正转动惯量的参数，下面为已修正的参数

// Q = np.diag([30, 1, 100, 1, 2000, 1])
// R_mat = np.diag([100, 1]) 
// float ChassisL_LQR_K[12] =     { -2.33647421, -0.21081156, -0.87849161, -0.74250485, 2.75285200, 0.19102688, 7.69537749, 0.93227315, 4.77757781, 3.87075519, 37.88178286, 0.87056623 };
// float ChassisR_LQR_K[12] =     { -2.33647421, -0.21081156, -0.87849161, -0.74250485, 2.75285200, 0.19102688, 7.69537749, 0.93227315, 4.77757781, 3.87075519, 37.88178286, 0.87056623 };


// Q = np.diag([100, 1, 300, 1, 2000, 1])
// R_mat = np.diag([100, 1]) 
// float ChassisL_LQR_K[12] =  { -2.74133106, -0.25234388, -1.49033108, -1.12717041, 3.00441907, 0.21424817, 10.83915504, 1.20519665, 8.82560642, 6.34208576, 36.29329271, 0.72497479 };
// float ChassisR_LQR_K[12] =  { -2.74133106, -0.25234388, -1.49033108, -1.12717041, 3.00441907, 0.21424817, 10.83915504, 1.20519665, 8.82560642, 6.34208576, 36.29329271, 0.72497479 };
// float ChassisL_LQR_K_fall[12] = { 0, 0, 0, 0, 0, 0, 10.83915504, 1.20519665, 0, 0, 0, 0 };
// float ChassisR_LQR_K_fall[12] = { 0, 0, 0, 0, 0, 0, 10.83915504, 1.20519665, 0, 0, 0, 0 };


// float ChassisL_LQR_K[12] =    { -2.57306786, -0.25248731, -1.94458695, -1.18501242, 2.88524773, 0.21129586, 8.75520085, 1.15993421, 11.03893841, 6.30525585, 37.18747339, 0.76009844 };
// float ChassisR_LQR_K[12] =    { -2.57306786, -0.25248731, -1.94458695, -1.18501242, 2.88524773, 0.21129586, 8.75520085, 1.15993421, 11.03893841, 6.30525585, 37.18747339, 0.76009844 };
float ChassisL_LQR_K_fall[12] = { 0, 0, 0, 0, 0, 0, 2.79517503, 0.42907118, 0, 0, 0, 0 };
float ChassisR_LQR_K_fall[12] = { 0, 0, 0, 0, 0, 0, 2.79517503, 0.42907118, 0, 0, 0, 0 };
float ChassisL_LQR_K_err[12] = { 0, 0, 0, 0, 0, 0, 46.61749743, 0, 0, 0, 0, 0 };
float ChassisR_LQR_K_err[12] = { 0, 0, 0, 0, 0, 0, 46.61749743, 0, 0, 0, 0, 0 };
// float ChassisL_LQR_K_stand[12] =  { -2.49358077, -0.17743955, -0.75196386, -0.90060444, 2.52069230, 0.20872615, 0,0,0,0,0,0 };
// float ChassisR_LQR_K_stand[12] =  { -2.49358077, -0.17743955, -0.75196386, -0.90060444, 2.52069230, 0.20872615, 0,0,0,0,0,0 };

// 左可立
// Q = np.diag([5000, 1, 100, 1, 2000, 1])
// R_mat = np.diag([100, 10]) 
// float ChassisL_LQR_K_stand[12] =    { 0,0,0,0,0,0, 17.25636415, 0.42645754, 1.17270605, 2.04871995, 9.73346412, 0.30504372 };
// float ChassisR_LQR_K_stand[12] =    { 0,0,0,0,0,0, 17.25636415, 0.42645754, 1.17270605, 2.04871995, 9.73346412, 0.30504372 };

// float ChassisL_LQR_K_stand[12] =   {0,0,0,0,0,0, 19.94149649, 0.46146564, 1.59639550, 1.87118765, 59.52061373, 1.21886661 };
// float ChassisR_LQR_K_stand[12] =   {0,0,0,0,0,0, 19.94149649, 0.46146564, 1.59639550, 1.87118765, 59.52061373, 1.21886661 };

float ChassisL_LQR_K_stand[12] =   { -10.66214907, -0.52427025, -2.69869525, -3.99613602, 11.26835300, 0.50583586, 60.38362404, 1.71202559, 9.02836186, 13.11211417, 50.32167135, 0.44678310 };
float ChassisR_LQR_K_stand[12] =    { -10.66214907, -0.52427025, -2.69869525, -3.99613602, 11.26835300, 0.50583586, 60.38362404, 1.71202559, 9.02836186, 13.11211417, 50.32167135, 0.44678310 };


// 测试劈叉
// float ChassisL_LQR_K[12] =  { -3.00582891, -0.28711445, -2.25077150, -1.43275189, 3.84916832, 0.23853827, 8.81439000, 0.99564434, 9.66451066, 5.81331273, 69.49485518, 1.03722237};
// float ChassisR_LQR_K[12] =  { -3.00582891, -0.28711445, -2.25077150, -1.43275189, 3.84916832, 0.23853827, 8.81439000, 0.99564434, 9.66451066, 5.81331273, 69.49485518, 1.03722237};
float ChassisL_LQR_K[12] = { 0,0,0,0,0,0, 11.37241207, 0.36676961, 1.36501008, 2.23794987, 19.54621010, 0.43702494 };
float ChassisR_LQR_K[12] = { 0,0,0,0,0,0, 11.37241207, 0.36676961, 1.36501008, 2.23794987, 19.54621010, 0.43702494 };

// 除了有点晃，其他还行
// Q = np.diag([1, 1, 1000, 1, 6000, 1])
// R_mat = np.diag([200, 1]) 
// float ChassisL_LQR_K_coeffs[12][4] = {
//     { -262.15221436, 151.12307163, -41.93627209, 0.37869840 },
//     { -10.19093166, 4.75149259, -3.34186193, 0.05301955 },
//     { -391.51555322, 188.11793533, -31.16737964, -0.40280973 },
//     { -192.09767761, 92.81332421, -16.57296577, -0.28429951 },
//     { -739.66193592, 428.80853833, -92.54961548, 8.67126617 },
//     { -10.12955740, 7.69673210, -2.20302198, 0.36062763 },
//     { 365.73211171, 59.83583160, -81.18273460, 16.80229870 },
//     { 14.30929003, 14.74102013, -9.04446721, 1.93914861 },
//     { -4537.68013676, 2570.01163050, -536.04089696, 45.65997389 },
//     { -2725.32701155, 1506.95819752, -306.14086322, 25.52148688 },
//     { 15540.54163483, -7527.91577495, 1264.11563857, 1.69474956 },
//     { 384.42028380, -197.30918451, 36.43113163, -1.16500456 },
// };
// float ChassisR_LQR_K_coeffs[12][4] = {
//     { -262.15221436, 151.12307163, -41.93627209, 0.37869840 },
//     { -10.19093166, 4.75149259, -3.34186193, 0.05301955 },
//     { -391.51555322, 188.11793533, -31.16737964, -0.40280973 },
//     { -192.09767761, 92.81332421, -16.57296577, -0.28429951 },
//     { -739.66193592, 428.80853833, -92.54961548, 8.67126617 },
//     { -10.12955740, 7.69673210, -2.20302198, 0.36062763 },
//     { 365.73211171, 59.83583160, -81.18273460, 16.80229870 },
//     { 14.30929003, 14.74102013, -9.04446721, 1.93914861 },
//     { -4537.68013676, 2570.01163050, -536.04089696, 45.65997389 },
//     { -2725.32701155, 1506.95819752, -306.14086322, 25.52148688 },
//     { 15540.54163483, -7527.91577495, 1264.11563857, 1.69474956 },
//     { 384.42028380, -197.30918451, 36.43113163, -1.16500456 },
// };

// 使用真实扭矩常数
// Q = np.diag([1, 1, 1000, 1, 6000, 1])
// R_mat = np.diag([50, 50]) 
// float ChassisL_LQR_K_coeffs[12][4] = {
//     { -144.14565858, 86.05136242, -34.14143626, -0.87122992 },
//     { 4.10059993, -4.68135863, -2.37990835, -0.11892495 },
//     { -102.18798169, 46.63010619, -7.13769689, -4.10391136 },
//     { 37.40779433, -19.70815236, 1.58654235, -2.26004218 },
//     { -1125.55005057, 585.93510956, -109.88337351, 8.18128863 },
//     { -32.21948998, 17.97426402, -3.76168254, 0.45121770 },
//     { -70.35613056, 41.96875475, -9.08451573, 1.03803627 },
//     { -12.87784892, 7.50492148, -1.74490343, 0.13585876 },
//     { -416.90620455, 216.09107115, -39.93262583, 2.65158351 },
//     { -224.41943261, 114.39417491, -20.73984573, 1.32626323 },
//     { 374.19785125, -174.92364514, 27.95856570, 9.97374881 },
//     { 19.43804554, -9.71718049, 1.75616928, 0.31184803 },
// };
// float ChassisR_LQR_K_coeffs[12][4] = {
//     { -144.14565858, 86.05136242, -34.14143626, -0.87122992 },
//     { 4.10059993, -4.68135863, -2.37990835, -0.11892495 },
//     { -102.18798169, 46.63010619, -7.13769689, -4.10391136 },
//     { 37.40779433, -19.70815236, 1.58654235, -2.26004218 },
//     { -1125.55005057, 585.93510956, -109.88337351, 8.18128863 },
//     { -32.21948998, 17.97426402, -3.76168254, 0.45121770 },
//     { -70.35613056, 41.96875475, -9.08451573, 1.03803627 },
//     { -12.87784892, 7.50492148, -1.74490343, 0.13585876 },
//     { -416.90620455, 216.09107115, -39.93262583, 2.65158351 },
//     { -224.41943261, 114.39417491, -20.73984573, 1.32626323 },
//     { 374.19785125, -174.92364514, 27.95856570, 9.97374881 },
//     { 19.43804554, -9.71718049, 1.75616928, 0.31184803 },
// };

// 更改优先级为High
// Q = np.diag([1000, 1, 500, 1, 6000, 1])
// R_mat = np.diag([500, 300]) 
// float ChassisL_LQR_K_coeffs[12][4] = {
//     { -155.79420016, 93.48549264, -26.96525166, -1.03329305 },
//     { -1.13896078, 1.06500997, -2.15311826, -0.01700966 },
//     { -23.10343501, 11.55306135, -2.02024014, -0.87260694 },
//     { 38.82557525, -19.80694710, 3.38088922, -1.11614050 },
//     { -301.77794129, 169.91815101, -36.73347618, 3.71204510 },
//     { -13.58092415, 8.22690205, -1.99247100, 0.28440378 },
//     { -96.47753930, 56.14444309, -12.42559389, 1.71733179 },
//     { -0.03895015, 0.48477045, -0.30107342, 0.05916544 },
//     { -61.83127718, 36.34152549, -8.09925658, 0.75037207 },
//     { -92.13816470, 49.47716345, -9.84053904, 0.79145569 },
//     { 272.47969019, -135.54041380, 23.87634900, 3.49970604 },
//     { 15.88302005, -8.36945903, 1.62311131, 0.15279192 },
// };
// float ChassisR_LQR_K_coeffs[12][4] = {
//     { -155.79420016, 93.48549264, -26.96525166, -1.03329305 },
//     { -1.13896078, 1.06500997, -2.15311826, -0.01700966 },
//     { -23.10343501, 11.55306135, -2.02024014, -0.87260694 },
//     { 38.82557525, -19.80694710, 3.38088922, -1.11614050 },
//     { -301.77794129, 169.91815101, -36.73347618, 3.71204510 },
//     { -13.58092415, 8.22690205, -1.99247100, 0.28440378 },
//     { -96.47753930, 56.14444309, -12.42559389, 1.71733179 },
//     { -0.03895015, 0.48477045, -0.30107342, 0.05916544 },
//     { -61.83127718, 36.34152549, -8.09925658, 0.75037207 },
//     { -92.13816470, 49.47716345, -9.84053904, 0.79145569 },
//     { 272.47969019, -135.54041380, 23.87634900, 3.49970604 },
//     { 15.88302005, -8.36945903, 1.62311131, 0.15279192 },
// };

float ChassisL_LQR_K_coeffs[12][4] = {
    { -285.22459348, 160.16536704, -39.79112310, -0.70315492 },
    { -4.23285506, 2.87719681, -2.85849581, 0.00742161 },
    { -67.07723341, 35.31631988, -6.58059100, -0.96385791 },
    { 16.25031899, -8.63277456, 1.48083710, -1.29134965 },
    { -254.30952977, 163.83668899, -40.86711606, 4.74139875 },
    { -7.86096005, 5.93785516, -1.77825572, 0.31290147 },
    { -184.62310235, 138.77713795, -39.33067971, 5.41936932 },
    { 17.05174151, -6.62133351, 0.41141619, 0.14660154 },
    { -122.31168350, 88.38448580, -23.77188050, 2.65261161 },
    { -256.56748788, 146.92311373, -31.51995643, 2.81684047 },
    { 902.15727354, -461.52094710, 83.86353481, 2.63469327 },
    { 39.63165411, -21.78056886, 4.40311581, 0.00843141 },
};
float ChassisR_LQR_K_coeffs[12][4] = {
    { -285.22459348, 160.16536704, -39.79112310, -0.70315492 },
    { -4.23285506, 2.87719681, -2.85849581, 0.00742161 },
    { -67.07723341, 35.31631988, -6.58059100, -0.96385791 },
    { 16.25031899, -8.63277456, 1.48083710, -1.29134965 },
    { -254.30952977, 163.83668899, -40.86711606, 4.74139875 },
    { -7.86096005, 5.93785516, -1.77825572, 0.31290147 },
    { -184.62310235, 138.77713795, -39.33067971, 5.41936932 },
    { 17.05174151, -6.62133351, 0.41141619, 0.14660154 },
    { -122.31168350, 88.38448580, -23.77188050, 2.65261161 },
    { -256.56748788, 146.92311373, -31.51995643, 2.81684047 },
    { 902.15727354, -461.52094710, 83.86353481, 2.63469327 },
    { 39.63165411, -21.78056886, 4.40311581, 0.00843141 },
};

// 拟合K矩阵
void Chassis_Fit_K(float coeffs[][4], float leg_length, float *LQR_K)
{
    // 三次多项式，后可考虑exp
    for (int i = 0; i < 12; i++)
    {
        LQR_K[i] =  coeffs[i][0] * leg_length * leg_length * leg_length +
                    coeffs[i][1] * leg_length * leg_length +
                    coeffs[i][2] * leg_length +
                    coeffs[i][3];
    }
}

GetLQR_K_t LQR_send_data;

// 通过串口修改K矩阵，实现实时调lqr
int8_t Chassis_Get_K(GetLQR_K_t *rx_data)
{
    if (rx_data->data[0] != 0xCD || rx_data->data[49] != 0xDC)
    {
        return -1;
    }
    memcpy(ChassisL_LQR_K, rx_data->K_data.LQR_K, sizeof(float) * 12);
    return 0;
}